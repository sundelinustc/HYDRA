---
title: "SDL_HYDRA_PTSD"
author: "Delin Sun"
date: "4/1/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
```

```
Statistical analyses of HYDRA outputs (by Delin Sun, Duke University, 04/16/2021)
The whole pipeline of the HYDRA project:
(1) Resting-state fMRI mean time series were extracted from 14 or 90 ROIs, which are in fact ICA-derived networks from FindLab.
(2) R-to-Z transformed Pearson's Correlation Coefficients between the time series from each pair of ROIs were calculated as features.
(3) All features (N=91 for 14 ROIs, and N=4005 for 90 ROIs) were harmonized to remove Site effects while keeping the information associated with bioogically relevant variables including disgnosis, age, and sex.
(4) Features + raw label of diagnosis (-1=controls, 1=patients) as well as covariates (age, age^2, sex) were entered into HYDRA to remove the effects of covariates and then cluster the patients into subgroups. The output ARI value was used to select the optimal number of subgroups. The output new labels separated patients into subgroups.
(5) This script aims to do the statistical analyses on HYDRA outputs to delineate their associations with demographic and clinical information.
```


```{r,include=FALSE}
# packages
library(tidyverse) # data manipulation and visualization
library(lme4) # for linear mixed regression models
library(lmerTest)# for p-value of lme4's models
library(ggplot2)
library(reshape2)
library(ggsci)
library(RColorBrewer) # for some extra colours in one of the graphs
library(table1) # make Table 1, mainly demographic & clinical info
library(sjPlot) # plot interactions of lm/lmer outputs
library(ggpubr) # plot multiple panels
library(forcats) # reorder the factors for plot
library(xlsx)

# library(ggpubr) # make easily publication ready plots
# library(rstatix) # pipe-friendly R functions for easy statistical analyses

# library(rayshader) # 2D plots to 3D plots
```

```{r,include=FALSE}
# define ROIs
  #roinames <- c("anterior_Salience","Auditory","Basal_Ganlia","dDMN","high_Visual","Language","LECN","post_Salience","Precuneus","prim_Visual","RECN","Sensorimotor","vDMN","Visuospatial")#14 ROIs
  roinames <- c("aS01","aS02","aS03","aS04","aS05","aS06","aS07",
                "Au01","Au02","Au03",
                "BG01","BG02","BG03","BG04","BG05",
                "dDMN01","dDMN02","dDMN03","dDMN04","dDMN05","dDMN06","dDMN07","dDMN08","dDMN09",
                "hVis01","hVis02",
                "Lan01","Lan02","Lan03","Lan04","Lan05","Lan06","Lan07",
                "LECN01","LECN02","LECN03","LECN04","LECN05","LECN06",
                "pS01","pS02","pS03","pS04","pS05","pS06","pS07","pS08","pS09","pS10","pS11","pS12",
                "Pre01","Pre02","Pre03","Pre04",
                "pVis01","pVis02",
                "RECN01","RECN02","RECN03","RECN04","RECN05","RECN06",
                "SM01","SM02","SM03","SM04","SM05","SM06",
                "vDMN01","vDMN02","vDMN03","vDMN04","vDMN05","vDMN06","vDMN07","vDMN08","vDMN09","vDMN10",
                "VS01","VS02","VS03","VS04","VS05","VS06","VS07","VS08","VS09","VS10","VS11")#90 ROIs
#######################################################################
# a function to plot heatmap for matrix of coefficients or p-values
# Input
# --- x, a vector, e.g. Pval0['Group',]
# --- title, title of the coclor bar, e.g. 'P-val (FDR corr.)'
# --- fmidpoint, mid point of the color bar, e.g. 0.05
# --- flimit, min and max of the color bar, e.g. c(0,1)
# --- roi, rois (part or all of the 90 regions) to show
# Output
# --- a heatmap representing the input matrix
SDL_mheat <- function(x,title='Pearson Correlation',fmidpoint=0,flimit=c(-1,1),roi=NULL){
    # corr. coef. matrix
  n <- 90 # 14 or 90 ROIs from FindLab
  m <- matrix(data=0, nrow=n, ncol=n)
  m[lower.tri(m, diag=FALSE)] <- x
  m <- t(m)
  m[lower.tri(m, diag=FALSE)] <- x
  
  rownames(m) <- roinames
  colnames(m) <- roinames

  if (!is.null(roi)){m <- m[roi, roi]} # plot selected rois

  # ggplot2 shows heatmap
  mm <- melt(m)
  # head(mm)
  mm %>% ggplot(aes(Var2, Var1, fill = value))+ geom_tile(color = "white")+ scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = fmidpoint, limit = flimit, space = "Lab", name=title) +theme_minimal()+ theme(axis.text.x =element_text(angle = 90, vjust = 1, size = 12, hjust = 1))+coord_fixed()
}
##############################################################################


#######################################################################
# a function to write the significant results into .xlsx file sheets
# Input
# --- Tval, a vector of T values, e.g. Tval0['Group',]
# --- pval, a vector of p values, e.g. Pval0['Group',]
# --- Thr, statistical threshold, e.g. 0.001
# --- fname, file name
# --- sheetName, excel sheet name
# --- roi, rois (part or all of the 90 regions) to show
# Output
# --- a .xlsx file to store the significant results in designated sheet
SDL_writeResults <- function(Tval,pval,Thr=0.05,fname,sheetName,roi=NULL){
  n <- 90 # 14 or 90 ROIs from FindLab
  mp <- matrix(data=999, nrow=n, ncol=n) # matrix to contain p-values
  mT <- matrix(data=999, nrow=n, ncol=n) # matrix to contain T-values
  mp[lower.tri(mp, diag=FALSE)] <- pval
  mT[lower.tri(mT, diag=FALSE)] <- Tval
  
  rownames(mp) <- roinames
  colnames(mp) <- roinames
  rownames(mT) <- roinames
  colnames(mT) <- roinames

  if (!is.null(roi)){mp <- mp[roi, roi]} # investigate within the selected rois
  if (!is.null(roi)){mT <- mT[roi, roi]} # investigate within the selected rois

  mmp <- melt(mp) %>% filter(value<Thr) # only keep significant results
  colnames(mmp) <- c('ROI1','ROI2','p_unc') # change the column names of variables
  
  mmT <- melt(mT) 
  colnames(mmT) <- c('ROI1','ROI2','T') # change the column names of variables
  
  mmT <- mmT %>% merge(mmp,by=c("ROI1","ROI2"),all=TRUE) %>% na.omit() %>% .[order(.$T),] # merge T & p-val, and re-order the dataframe according to T-values (accending order)
  
  if (dim(mmp)[1]==0){
    mmT <- 'No Significant Results'} # if there is no significant results, make a NaN entry
  
  write.xlsx(mmT, fname, sheetName=sheetName, col.names=TRUE, row.names=FALSE, append=TRUE)
}
##############################################################################
```

# (1.0) Demographic & Clinical Info (Post-Traumatic Stress Disorder)
```{r,echo=FALSE}
# df <- read.csv("..\\Origins\\PTSD\\SbjDemoClinScanInfo.csv",header=T,sep=",") # load data
# 
# df$Sex <- df$Sex %>% as.factor() %>% plyr::revalue(c("F"="Female","F "="Female", "M"="Male"))
# df <- df[df$Sex=='Male' | df$Sex=='Female',] # keep thoese with clear sex info
# 
# df <- df[df$Age>0 & df$Age<100,] # remove too extreme age values
# df <- df[complete.cases(df$Age),] # remove NA from Age
# 
# df$Group <- df$Current.PTSD.diagnosis %>% as.factor() %>% plyr::revalue(c("PTSD "="PTSD","PTSD  "="PTSD","PTSD-DS"="PTSD","PTSDpDS"="PTSD","control"="Control","Subthreshold"="Control","Subthreshold "="Control","Controls"="Control","Trauma Control"="Control","Healthy control"="Control","CONTROL"="Control","trauma-exposed adults without PTSD"="Control"))
# 
# write.csv(df,'SbjDemoClinScanInfo1.csv',row.names=FALSE) # data per ROI
# 
# 
# df_CONT <- df %>% filter(Group=="Control") %>% group_by(ScannerSite) %>% get_summary_stats(Age, type = "mean_sd") # number of subjects & meand/SD of Age
# df_CONT <- df %>% filter(Group=="Control" & Sex=='Male') %>% group_by(ScannerSite) %>% summarise(N_male=n()) %>% merge(df_CONT,by="ScannerSite",all=TRUE) # add number of males
# df_CONT <- df %>% filter(Group=="Control" & Sex=='Female') %>% group_by(ScannerSite) %>% summarise(N_female=n()) %>% merge(df_CONT,by="ScannerSite",all=TRUE) # add number of males
# ## PTSD
# df_PTSD <- df %>% filter(Group=="PTSD") %>% group_by(ScannerSite) %>% get_summary_stats(Age, type = "mean_sd") # number of subjects & meand/SD of Age
# df_PTSD <- df %>% filter(Group=="PTSD" & Sex=='Male') %>% group_by(ScannerSite) %>% summarise(N_male=n()) %>% merge(df_PTSD,by="ScannerSite",all=TRUE) # add number of males
# df_PTSD <- df %>% filter(Group=="PTSD" & Sex=='Female') %>% group_by(ScannerSite) %>% summarise(N_female=n()) %>% merge(df_PTSD,by="ScannerSite",all=TRUE) # add number of males
# ## merge Control and PTSD
# df <- merge(df_CONT,df_PTSD,by="ScannerSite",all=TRUE)
# write.csv(df,'Table1.csv',row.names=FALSE) # data per ROI
# df
```


# Demographic and Clinical Info (Post-Traumatic Stress Disorder)
```{r,echo=FALSE}
df0 <- read.csv("..\\Output\\FindLab90\\timeseries_PTSD\\All_harmonized.csv",header=T,sep=",")

# define factors
df0$Sex      <- df0$Sex %>% as.factor() %>% plyr::revalue(c("2"="Female", "1"="Male"))

df0$Group    <- df0$Group %>% as.factor() %>% plyr::revalue(c("-1"="Control", "1"="PTSD"))
df0$NewGroup <- df0$NewGroup %>% as.factor() %>% plyr::revalue(c("-1"="Control", "1"="PTSD1","2"="PTSD2"))
df0          <- df0 %>% mutate(Group=fct_relevel(Group,"Control","PTSD"), NewGroup=fct_relevel(NewGroup,"Control","PTSD1","PTSD2"),Sex=fct_relevel(Sex,"Male","Female")) # reorder the levels of each factor
df0$Site <- df0$SITE %>% as.factor()


# df <- read.csv("..\\Origins\\PTSD\\SbjDemoClinScanInfo.csv",header=T,sep=",") %>% merge(df0,by="fID",all.y=TRUE)
# write.csv(df,'PTSD_Datasets_5Sites.csv',row.names=FALSE) 
```

### Mean & SD per group (old labels)
```{r}
df <- df0 # just to keep df0 untouched
df %>% group_by(Group) %>% get_summary_stats(Age, type = "mean_sd")
```

### Number of subjects per group (old labels)
```{r}
df <- df0
df %>% group_by(Group,Sex) %>% summarise(n=n())
```

### heatmap of the corr. coef. in a sample subject
```{r}
# df_data[1,2:92] %>% as.numeric() %>% SDL_mheat(title='Pearson\nCorr. Coef.', fmidpoint=0, flimit=c(-1,1))
```

### Nean & SD per group (new labels)
```{r}
df <- df0 # just to keep df0 untouched
dfx <- df %>% group_by(NewGroup) %>% get_summary_stats(Age, type = "mean_sd")
dfx
aov(Age ~ NewGroup, data = df) %>% summary()
```

### Number of subjects per group (new labels)
```{r}
df <- df0 # just to keep df0 untouched
dfx <- df %>% group_by(NewGroup,Sex) %>% summarise(n=n())
dfx
dfx$n %>% matrix(2,3) %>% chisq.test()
```

### Number of subjects, group_by(NewGroup,Site)
```{r}
df <- df0
df1 <- df %>% group_by(NewGroup,Site) %>% summarise(n=n())
df1 %>% ggplot(aes(fill=NewGroup, y=n, x=Site, label=n)) + geom_bar(position="stack", stat="identity") +ylab("Number of Participants") + geom_text(size=3, position=position_stack(vjust = 0.5))
m <- df1$n %>% matrix(5,3) %>% t() # row 1,2&3 = Control, PAT1, & PAT2
m <- m[2:3,] # PAT1 & PAT2
m
m %>% chisq.test() # Pearson's Chi-squared Test for Count Data

m1 <- m/t(replicate(2,colSums(m)))
m1
m1 %>% chisq.test() # test on ratio data
```

### Age, group_by(NewGroup,Site)
```{r}
df <- df0
df %>% group_by(NewGroup,Site) %>% get_summary_stats(Age, type = "mean_sd")
df %>% ggplot(aes(x=Site, y=Age, fill=NewGroup)) + geom_boxplot() + xlab("Site") + ylab("Age (Years)")
aov(Age ~ SITE * NewGroup, data = df) %>% summary()
```

### Current PTSD severity, group_by(NewGroup,Site)
```{r}
# dfx$CurrentPTSDSeverity <- dfx$Current.PTSD.severity %>% as.numeric()
# dfx %>% group_by(NewGroup,SITE) %>% get_summary_stats(CurrentPTSDSeverity, type = "mean_sd")
# dfx %>% ggplot(aes(x=SITE, y=CurrentPTSDSeverity, fill=NewGroup)) + geom_boxplot() + xlab("Site") + ylab("Current PTSD Severity")
```



```{r}
#######################################################################
# a function to model (lm or lmer) data for each ROI-to-ROI connection, and extract models/coefficients/p-values of models
# Input
# --- y, dataframe column, e.g. df$col01, or select(col1:col10)
# --- df, dataframe
# --- Otype, the type of outputs, e.g. "model", "coef", and "p"
# --- ftxt, text for the formula, e.g. "lmer(formula = y ~ age_d + age_m + drinking_class + sex + race + ses + fh_alc_density + life_trauma_RP + (1|participant_id)"
# --- fterms, which factor to be plotted
# --- fxy, x and y labels
# Output
# --- model, list of models
# --- coef,  matrix of coefficients
# --- pval,  matrix of coefficients
# --- plt,   list of plotting objects
SDL_lm <- function(y,df,Otype,ftxt,fterms=NULL,fxy=NULL){
  model <- eval(parse(text=paste(substr(ftxt,1,nchar(ftxt)-1),", data = df)")))
  coef  <- model %>% summary() %>% coefficients() # Estimate, Std. Error, t value, Pr(>|t|)
  tval  <- coef %>% .[,"t value"] 
  pval  <- coef %>% .[,"Pr(>|t|)"]
  #plt   <- model %>% plot_model(type = "pred", terms = fterms, title = "", axis.title = fxy)
  switch(Otype,"model"=return(model),"coef"=return(list(coef)),"tval"=return(tval),"pval"=return(pval),"plt"=return(list(plt)))
}
##############################################################################
```

# Between-group comparisons


### Harmonize_PTSD_4site_5-27-21
```{r,echo=FALSE}
# load data
df1 <- read.csv("..\\Output\\FindLab90\\timeseries_PTSD\\Harmonize_PTSD_4site_5-27-21.csv", header=T, sep=",") %>% rename(StudySite=ï..Site, ID=PIN) # harmonized Item data
df2 <- read.csv("..\\Origins\\PTSD\\SbjDemoClinScanInfo.csv",header=T, sep=",") %>% select(c(ï..StudySite,ID,fID)) %>% rename(StudySite=ï..StudySite)# original info
df <- df1 %>% merge(df2, c("StudySite","ID"), all=FALSE) # merge to match fID & clinical items
df <- df0 %>% merge(df,"fID",all=FALSE) # merge for analyses
df <- df[!duplicated(df$fID),] # remove duplicated subjects

df <- df[df$NewGroup!="Control",] # only comparing among subgroups
df01 <- df # backup for further analyses


Tval <- df %>% select(B1:D_total) %>% sapply(SDL_lm, df=df, Otype="tval", ftxt="lm(formula = y ~ NewGroup + Age + Sex)") %>% as.data.frame()

Pval <- df %>% select(B1:D_total) %>% sapply(SDL_lm, df=df, Otype="pval", ftxt="lm(formula = y ~ NewGroup + Age + Sex)")  %>% as.data.frame() 
Pval1 <- Pval["NewGroupPTSD2",] # only see these factors
as.matrix((Pval1 < 0.07) + 0) # 1:p<0.05, 0:p>=0.05

# plots --D1
df %>% ggplot(aes(x=NewGroup, y=D1, fill=NewGroup)) + geom_boxplot() + xlab("NewGroup") + ylab("D1")

# plots --D3
df %>% ggplot(aes(x=NewGroup, y=D3, fill=NewGroup)) + geom_boxplot() + xlab("NewGroup") + ylab("D3")

```


# Between-group comparisons
```{r,echo=FALSE}
# rois of interest
## anterior/posterior Salience networks, ventral/dorsal default mode networks, left/right executive control networks
roi <- c("aS01","aS02","aS03","aS04","aS05","aS06","aS07",
         "pS01","pS02","pS03","pS04","pS05","pS06","pS07","pS08","pS09","pS10","pS11","pS12",          "vDMN01","vDMN02","vDMN03","vDMN04","vDMN05","vDMN06","vDMN07","vDMN08","vDMN09","vDMN10",
         "dDMN01","dDMN02","dDMN03","dDMN04","dDMN05","dDMN06","dDMN07","dDMN08","dDMN09",
         "LECN01","LECN02","LECN03","LECN04","LECN05","LECN06",
         "RECN01","RECN02","RECN03","RECN04","RECN05","RECN06")

fname_results = "..\\Output\\FindLab90\\timeseries_PTSD\\Table_Between_Group_Comp.xlsx"
unlink(fname_results) # remove the file at first hand to avoid conflicts

# raw, PTSDD vs Control
df <- df0
# patients vs. control
Tval0 <- df %>% select(V1:V4005) %>% sapply(SDL_lm, df=df, Otype="tval", ftxt="lm(formula = y ~ Group + Age + Sex)")
x <- Tval0['GroupPTSD',]
SDL_mheat(x=x, title='T-value', fmidpoint=0, flimit=c(min(x),max(x)), roi=roi)

Pval0 <- df %>% select(V1:V4005) %>% sapply(SDL_lm, df=df, Otype="pval", ftxt="lm(formula = y ~ Group + Age + Sex)") 
x <- -1* log10(Pval0['GroupPTSD',])
SDL_mheat(x=x, title='-1*log10(P_unc)', fmidpoint=-1*log10(0.001), flimit=c(0.1,5),roi=roi)

SDL_writeResults(Tval0['GroupPTSD',],Pval0['GroupPTSD',],0.001,fname=fname_results,sheetName="PTSD_vs_Control",roi=roi)

# New, PTSD1 vs Control
df <- df0 %>% filter(NewGroup=="PTSD1" | NewGroup=="Control") %>% mutate(Group=Group)
Tval0 <- df %>% select(V1:V4005) %>% sapply(SDL_lm, df=df, Otype="tval", ftxt="lm(formula = y ~ Group + Age + Sex)")
x <- Tval0['GroupPTSD',]
SDL_mheat(x=x, title='T-value', fmidpoint=0, flimit=c(min(x),max(x)), roi=roi)

Pval0 <- df %>% select(V1:V4005) %>% sapply(SDL_lm, df=df, Otype="pval", ftxt="lm(formula = y ~ Group + Age + Sex)") 
x <- -1* log10(Pval0['GroupPTSD',])
SDL_mheat(x=x, title='-1*log10(P_unc)', fmidpoint=-1*log10(0.001), flimit=c(0.1,5),roi=roi)

SDL_writeResults(Tval0['GroupPTSD',],Pval0['GroupPTSD',],0.001,fname=fname_results,sheetName="PTSD1_vs_Control",roi=roi)

# New, PTSD2 vs Control
df <- df0 %>% filter(NewGroup=="PTSD2" | NewGroup=="Control") %>% mutate(Group=Group)
Tval0 <- df %>% select(V1:V4005) %>% sapply(SDL_lm, df=df, Otype="tval", ftxt="lm(formula = y ~ Group + Age + Sex)")
x <- Tval0['GroupPTSD',]
SDL_mheat(x=x, title='T-value', fmidpoint=0, flimit=c(min(x),max(x)), roi=roi)

Pval0 <- df %>% select(V1:V4005) %>% sapply(SDL_lm, df=df, Otype="pval", ftxt="lm(formula = y ~ Group + Age + Sex)") 
x <- -1* log10(Pval0['GroupPTSD',])
SDL_mheat(x=x, title='-1*log10(P_unc)', fmidpoint=-1*log10(0.001), flimit=c(0.1,5),roi=roi)

SDL_writeResults(Tval0['GroupPTSD',],Pval0['GroupPTSD',],0.001,fname=fname_results,sheetName="PTSD2_vs_Control",roi=roi)


# New, PTSD2 vs PTSD1
df <- df0 %>% filter(NewGroup=="PTSD1" | NewGroup=="PTSD2") %>% mutate(Group=NewGroup)
Tval0 <- df %>% select(V1:V4005) %>% sapply(SDL_lm, df=df, Otype="tval", ftxt="lm(formula = y ~ Group + Age + Sex)")
x <- Tval0['GroupPTSD2',]
SDL_mheat(x=x, title='T-value', fmidpoint=0, flimit=c(min(x),max(x)), roi=roi)

Pval0 <- df %>% select(V1:V4005) %>% sapply(SDL_lm, df=df, Otype="pval", ftxt="lm(formula = y ~ Group + Age + Sex)") 
x <- -1* log10(Pval0['GroupPTSD2',])
SDL_mheat(x=x, title='-1*log10(P_unc)', fmidpoint=-1*log10(0.001), flimit=c(0.1,5),roi=roi)

SDL_writeResults(Tval0['GroupPTSD2',],Pval0['GroupPTSD2',],0.001,fname=fname_results,sheetName="PTSD2_vs_PTSD1",roi=roi)

# New, FC & Clinical associations
## Harmonize_PTSD
df1 <- read.csv("..\\Output\\FindLab90\\timeseries_PTSD\\PTSD_Datasets_5Sites_Harmonized.csv",header=T,sep=",")
df <- df0 %>% merge(df1,by="fID",all=FALSE) %>% filter(NewGroup=="PTSD1" | NewGroup=="PTSD2") %>% mutate(Group=NewGroup)

df <- df01

Tval0 <- df %>% select(V1:V4005) %>% sapply(SDL_lm, df=df, Otype="tval", ftxt="lm(formula = y ~ Group*Harmonize_PTSD + Age + Sex)")
x <- Tval0['GroupPTSD2:Harmonize_PTSD',]
SDL_mheat(x=x, title='T-value', fmidpoint=0, flimit=c(min(x),max(x)), roi=roi)

Pval0 <- df %>% select(V1:V4005) %>% sapply(SDL_lm, df=df, Otype="pval", ftxt="lm(formula = y ~ Group*Harmonize_PTSD + Age + Sex)") 
x <- -1* log10(Pval0['GroupPTSD2:Harmonize_PTSD',])
SDL_mheat(x=x, title='-1*log10(P_unc)', fmidpoint=-1*log10(0.001), flimit=c(min(x),max(x)),roi=roi)

SDL_writeResults(Tval0['GroupPTSD2:Harmonize_PTSD',],Pval0['GroupPTSD2:Harmonize_PTSD',],0.001,fname=fname_results,sheetName="Group_by_Harmonize_PTSD",roi=roi)
```

```{r,echo=FALSE}
## Item data (from B1 to D_Total)
fname_results = "..\\Output\\FindLab90\\timeseries_PTSD\\Table_Between_Group_Comp_item-FC.xlsx"
unlink(fname_results) # remove the file at first hand to avoid conflicts

vlist <- df01 %>% select(B1:D_total) %>% colnames()

#vlist <- c('B1','B2','B3','B4','B5','B_total','C1','C2','C3','C4','C5','C6','C7','C_total','D1','D2','D3','D4','D5','D_total')

# write results to excel file
for (Var in vlist){
  ftxt <- paste0("lm(formula = y ~ Group*",Var," + Age + Sex)")
  feff <- paste0('GroupPTSD2:',Var) 

  df <- df01 %>% mutate(Group=NewGroup)

  Tval0 <- df %>% select(V1:V4005) %>% sapply(SDL_lm, df=df, Otype="tval", ftxt=ftxt)
  Pval0 <- df %>% select(V1:V4005) %>% sapply(SDL_lm, df=df, Otype="pval", ftxt=ftxt) 
  SDL_writeResults(Tval0[feff,],Pval0[feff,],0.001,fname=fname_results,sheetName=paste0("Group_by_",Var),roi=roi)
}

# plot T- & p-matrix, and representative FC-clinical associations
Var <- 'B_total'
ftxt <- paste0("lm(formula = y ~ Group*",Var," + Age + Sex)")
feff <- paste0('GroupPTSD2:',Var)
df <- df01 %>% mutate(Group=NewGroup)

Tval0 <- df %>% select(V1:V4005) %>% sapply(SDL_lm, df=df, Otype="tval", ftxt=ftxt)
x <- Tval0[feff,]
SDL_mheat(x=x, title='T-value', fmidpoint=0, flimit=c(min(x),max(x)), roi=roi)

Pval0 <- df %>% select(V1:V4005) %>% sapply(SDL_lm, df=df, Otype="pval", ftxt=ftxt) 
x <- -1* log10(Pval0[feff,])
SDL_mheat(x=x, title='-1*log10(P_unc)', fmidpoint=-1*log10(0.001), flimit=c(0.1,5),roi=roi)

x <- Pval0[feff,]
x[x<0.001] # V1406 for Group:B_total

# plot the effects of Group:Sex in a sample connection
y <- df[,"V1406"]
mod <- lm(formula = y ~ Group * B_total + Sex + Age, data=df)
mod %>% summary()
mod %>% plot_model(type = "pred", terms = c("B_total","Group"), title = "pSalience -to- dDMN FC",axis.title=c("B_total","rsFC")) # example plot of Group:Sex effect

df %>% select(V927) %>% sapply(SDL_lm, df=df, Otype="pval", ftxt=ftxt)


```









## Raw group labels 
```{r,echo=FALSE}
NameGroupEffect <- 'GroupPTSD'
NameGroupAge    <- 'GroupPTSD:Age'
NameGroupSex    <- 'GroupPTSD:SexFemale'

df <- df0
# patients vs. control
Tval0 <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="tval", ftxt="lm(formula = y ~ Group + Age + Sex)")
x <- Tval0[NameGroupEffect,]
SDL_mheat(x=x, title='T-value', fmidpoint=0, flimit=c(min(x),max(x)))

Pval0 <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="pval", ftxt="lm(formula = y ~ Group + Age + Sex)")  %>% t() %>% as.data.frame() %>% t()#sapply(p.adjust,method="fdr") %>% t()
x <- -1* log10(Pval0[NameGroupEffect,])
SDL_mheat(x=x, title='-1*log10(P_unc)', fmidpoint=-1*log10(0.05), flimit=c(min(x),max(x)))

# Effect of Age
Tval0 <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="tval", ftxt="lm(formula = y ~ Group + Age + Sex)")
x <- Tval0['Age',]
SDL_mheat(x=x, title='T-value', fmidpoint=0, flimit=c(min(x),max(x)))

Pval0 <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="pval", ftxt="lm(formula = y ~ Group + Age + Sex)")  %>% t() %>% as.data.frame() %>% sapply(p.adjust,method="fdr") %>% t()
x <- -1* log10(Pval0['Age',])
SDL_mheat(x=x, title='-1*log10(P_FDR)', fmidpoint=-1*log10(0.05), flimit=c(min(x),max(x)))

# Effect of Sex
Tval0 <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="tval", ftxt="lm(formula = y ~ Group + Age + Sex)")
x <- Tval0['SexFemale',]
SDL_mheat(x=x, title='T-value', fmidpoint=0, flimit=c(min(x),max(x)))

Pval0 <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="pval", ftxt="lm(formula = y ~ Group + Age + Sex)")  %>% t() %>% as.data.frame() %>% sapply(p.adjust,method="fdr") %>% t()
x <- -1* log10(Pval0['SexFemale',])
SDL_mheat(x=x, title='-1*log10(P_FDR)', fmidpoint=-1*log10(0.05), flimit=c(min(x),max(x)))

# Effect of Group:Age
Tval0 <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="tval", ftxt="lm(formula = y ~ Group * Age + Sex)")
x <- Tval0[NameGroupAge,]
SDL_mheat(x=x, title='T-value', fmidpoint=0, flimit=c(min(x),max(x)))

Pval0 <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="pval", ftxt="lm(formula = y ~ Group * Age + Sex)")  %>% t() %>% as.data.frame() %>% sapply(p.adjust,method="fdr") %>% t()
x <- -1* log10(Pval0[NameGroupAge,])
SDL_mheat(x=x, title='-1*log10(P_FDR)', fmidpoint=-1*log10(0.05), flimit=c(min(x),max(x)))

# plot the effects of Group:Age in a sample connection
y <- df[,"V42"]
mod <- lm(formula = y ~ Group * Age + Sex, data=df)
# mod %>% summary()
mod %>% plot_model(type = "pred", terms = c("Age","Group"), title = "dDMN-to-prim_Visual FC",axis.title=c("Age (Years)","rsFC")) # example plot of Group:Age effect

# scatter plots rsFC~Group:Age
df %>% ggplot(aes(x=Age, y=df[,"V42"], color=NewGroup, shape=Site)) + geom_point(size=2) + xlab("Age (Years)") + ylab("rsFC") + labs(title="dDMN-to-prim_Visual FC")


# Effect of Group:Sex
Tval0 <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="tval", ftxt="lm(formula = y ~ Group * Sex + Age)")
x <- Tval0[NameGroupSex,]
SDL_mheat(x=x, title='T-value', fmidpoint=0, flimit=c(min(x),max(x)))

Pval0 <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="pval", ftxt="lm(formula = y ~ Group * Sex + Age)")  %>% t() %>% as.data.frame() %>% sapply(p.adjust,method="fdr") %>% t()
x <- -1* log10(Pval0[NameGroupSex,])
SDL_mheat(x=x, title='-1*log10(P_FDR)', fmidpoint=-1*log10(0.05), flimit=c(min(x),max(x)))

# plot the effects of Group:Sex in a sample connection
y <- df[,"V56"]
mod <- lm(formula = y ~ Group * Sex + Age, data=df)
# mod %>% summary()
mod %>% plot_model(type = "pred", terms = c("Group","Sex"), title = "LECN-to-Language FC",axis.title=c("NewGroup","rsFC")) # example plot of Group:Sex effect

# scatter plots rsFC~Group:Sex
df %>% ggboxplot(x="NewGroup", y="V56", color="Sex") + xlab("NewGroup") + ylab("rsFC") + labs(title="LECN-to-Language FC")
```



# New groups: (PTSD1 + Controls) 
```{r,echo=FALSE}
# PTSD1 vs. controls
df <- df0 %>% filter(NewGroup!="PTSD2") # only groups -1 & 1
df$Group <- df$NewGroup %>% as.character() %>% as.factor() # remove the level of PTSD2
# df %>% SDL_mplt()

# PTSD vs. control
Tval0 <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="tval", ftxt="lm(formula = y ~ Group + Age + Sex)")
x <- Tval0['GroupPTSD1',]
SDL_mheat(x=x, title='T-value', fmidpoint=0, flimit=c(min(x),max(x)))

Pval0 <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="pval", ftxt="lm(formula = y ~ Group + Age + Sex)")  %>% t() %>% as.data.frame() %>% t()#sapply(p.adjust,method="fdr") %>% t()
x <- -1* log10(Pval0['GroupPTSD1',])
SDL_mheat(x=x, title='-1*log10(P_unc)', fmidpoint=-1*log10(0.05), flimit=c(min(x),max(x)))

# Effect of Age
Tval0 <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="tval", ftxt="lm(formula = y ~ Group + Age + Sex)")
x <- Tval0['Age',]
SDL_mheat(x=x, title='T-value', fmidpoint=0, flimit=c(min(x),max(x)))

Pval0 <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="pval", ftxt="lm(formula = y ~ Group + Age + Sex)")  %>% t() %>% as.data.frame() %>% sapply(p.adjust,method="fdr") %>% t()
x <- -1* log10(Pval0['Age',])
SDL_mheat(x=x, title='-1*log10(P_FDR)', fmidpoint=-1*log10(0.05), flimit=c(min(x),max(x)))

# Effect of Sex
Tval0 <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="tval", ftxt="lm(formula = y ~ Group + Age + Sex)")
x <- Tval0['SexFemale',]
SDL_mheat(x=x, title='T-value', fmidpoint=0, flimit=c(min(x),max(x)))

Pval0 <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="pval", ftxt="lm(formula = y ~ Group + Age + Sex)")  %>% t() %>% as.data.frame() %>% sapply(p.adjust,method="fdr") %>% t()
x <- -1* log10(Pval0['SexFemale',])
SDL_mheat(x=x, title='-1*log10(P_FDR)', fmidpoint=-1*log10(0.05), flimit=c(min(x),max(x)))

# Effect of Group:Age
Tval0 <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="tval", ftxt="lm(formula = y ~ Group * Age + Sex)")
x <- Tval0['GroupPTSD1:Age',]
SDL_mheat(x=x, title='T-value', fmidpoint=0, flimit=c(min(x),max(x)))

Pval0 <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="pval", ftxt="lm(formula = y ~ Group * Age + Sex)")  %>% t() %>% as.data.frame() %>% sapply(p.adjust,method="fdr") %>% t()
x <- -1* log10(Pval0['GroupPTSD1:Age',])
SDL_mheat(x=x, title='-1*log10(P_FDR)', fmidpoint=-1*log10(0.05), flimit=c(min(x),max(x)))

# plot the effects of Group:Age in a sample connection
y <- df[,"V42"]
mod <- lm(formula = y ~ Group * Age + Sex, data=df)
# mod %>% summary()
mod %>% plot_model(type = "pred", terms = c("Age","Group"), title = "dDMN-to-prim_Visual FC",axis.title=c("Age (Years)","rsFC")) # example plot of Group:Age effect

# scatter plots rsFC~Group:Age
df %>% ggplot(aes(x=Age, y=df[,"V42"], color=NewGroup)) + geom_point(size=2) + xlab("Age (Years)") + ylab("rsFC") + labs(title="dDMN-to-prim_Visual FC")


# Effect of Group:Sex
Tval0 <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="tval", ftxt="lm(formula = y ~ Group * Sex + Age)")
x <- Tval0['GroupPTSD1:SexFemale',]
SDL_mheat(x=x, title='T-value', fmidpoint=0, flimit=c(min(x),max(x)))

Pval0 <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="pval", ftxt="lm(formula = y ~ Group * Sex + Age)")  %>% t() %>% as.data.frame() %>% sapply(p.adjust,method="fdr") %>% t()
x <- -1* log10(Pval0['GroupPTSD1:SexFemale',])
SDL_mheat(x=x, title='-1*log10(P_FDR)', fmidpoint=-1*log10(0.05), flimit=c(min(x),max(x)))

# plot the effects of Group:Sex in a sample connection
y <- df[,"V56"]
mod <- lm(formula = y ~ Group * Sex + Age, data=df)
# mod %>% summary()
mod %>% plot_model(type = "pred", terms = c("Group","Sex"), title = "LCEN-to-Language FC",axis.title=c("NewGroup","rsFC")) # example plot of Group:Sex effect

# scatter plots rsFC~Group:Sex
df %>% ggboxplot(x="NewGroup", y="V56", color="Sex") + xlab("NewGroup") + ylab("rsFC") + labs(title="LCEN-to-Language FC")
```



## New groups: (PTSD2 + Controls)
```{r,echo=FALSE}
# PTSD2 vs. controls
df <- df0 %>% filter(NewGroup!="PTSD1") # only groups -1 & 2
df$Group <- df$NewGroup %>% as.character() %>% as.factor() # remove the level of PTSD1
# df %>% SDL_mplt()

# PTSD vs. control
Tval0 <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="tval", ftxt="lm(formula = y ~ Group + Age + Sex)")
x <- Tval0['GroupPTSD2',]
SDL_mheat(x=x, title='T-value', fmidpoint=0, flimit=c(min(x),max(x)))

Pval0 <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="pval", ftxt="lm(formula = y ~ Group + Age + Sex)")  %>% t() %>% as.data.frame() %>% t()#sapply(p.adjust,method="fdr") %>% t()
x <- -1* log10(Pval0['GroupPTSD2',])
SDL_mheat(x=x, title='-1*log10(P_unc)', fmidpoint=-1*log10(0.05), flimit=c(min(x),max(x)))

# Effect of Age
Tval0 <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="tval", ftxt="lm(formula = y ~ Group + Age + Sex)")
x <- Tval0['Age',]
SDL_mheat(x=x, title='T-value', fmidpoint=0, flimit=c(min(x),max(x)))

Pval0 <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="pval", ftxt="lm(formula = y ~ Group + Age + Sex)")  %>% t() %>% as.data.frame() %>% sapply(p.adjust,method="fdr") %>% t()
x <- -1* log10(Pval0['Age',])
SDL_mheat(x=x, title='-1*log10(P_FDR)', fmidpoint=-1*log10(0.05), flimit=c(min(x),max(x)))

# Effect of Sex
Tval0 <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="tval", ftxt="lm(formula = y ~ Group + Age + Sex)")
x <- Tval0['SexFemale',]
SDL_mheat(x=x, title='T-value', fmidpoint=0, flimit=c(min(x),max(x)))

Pval0 <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="pval", ftxt="lm(formula = y ~ Group + Age + Sex)")  %>% t() %>% as.data.frame() %>% sapply(p.adjust,method="fdr") %>% t()
x <- -1* log10(Pval0['SexFemale',])
SDL_mheat(x=x, title='-1*log10(P_FDR)', fmidpoint=-1*log10(0.05), flimit=c(min(x),max(x)))

# Effect of Group:Age
Tval0 <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="tval", ftxt="lm(formula = y ~ Group * Age + Sex)")
x <- Tval0['GroupPTSD2:Age',]
SDL_mheat(x=x, title='T-value', fmidpoint=0, flimit=c(min(x),max(x)))

Pval0 <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="pval", ftxt="lm(formula = y ~ Group * Age + Sex)")  %>% t() %>% as.data.frame() %>% sapply(p.adjust,method="fdr") %>% t()
x <- -1* log10(Pval0['GroupPTSD2:Age',])
SDL_mheat(x=x, title='-1*log10(P_FDR)', fmidpoint=-1*log10(0.05), flimit=c(min(x),max(x)))

# plot the effects of Group:Age in a sample connection
y <- df[,"V42"]
mod <- lm(formula = y ~ Group * Age + Sex, data=df)
# mod %>% summary()
mod %>% plot_model(type = "pred", terms = c("Age","Group"), title = "dDMN-to-prim_Visual FC",axis.title=c("Age (Years)","rsFC")) # example plot of Group:Age effect

# scatter plots rsFC~Group:Age
df %>% ggplot(aes(x=Age, y=df[,"V42"], color=NewGroup)) + geom_point(size=2) + xlab("Age (Years)") + ylab("rsFC") + labs(title="dDMN-to-prim_Visual FC")


# Effect of Group:Sex
Tval0 <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="tval", ftxt="lm(formula = y ~ Group * Sex + Age)")
x <- Tval0['GroupPTSD2:SexFemale',]
SDL_mheat(x=x, title='T-value', fmidpoint=0, flimit=c(min(x),max(x)))

Pval0 <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="pval", ftxt="lm(formula = y ~ Group * Sex + Age)")  %>% t() %>% as.data.frame() %>% sapply(p.adjust,method="fdr") %>% t()
x <- -1* log10(Pval0['GroupPTSD2:SexFemale',])
SDL_mheat(x=x, title='-1*log10(P_FDR)', fmidpoint=-1*log10(0.05), flimit=c(min(x),max(x)))

# plot the effects of Group:Sex in a sample connection
y <- df[,"V56"]
mod <- lm(formula = y ~ Group * Sex + Age, data=df)
# mod %>% summary()
mod %>% plot_model(type = "pred", terms = c("Group","Sex"), title = "LECN-to-Language FC",axis.title=c("NewGroup","rsFC")) # example plot of Group:Sex effect

# scatter plots rsFC~Group:Sex
df %>% ggboxplot(x="NewGroup", y="V56", color="Sex") + xlab("NewGroup") + ylab("rsFC") + labs(title="LECN-to-Language FC")
```



## New groups: (PTSD1 + PTSD2)
```{r,echo=FALSE}
# PTSD1 vs. PTSD2
df <- df0 %>% filter(NewGroup!="Control") 
df$Group <- df$NewGroup %>% as.character() %>% as.factor() # remove the level of Control
# df %>% SDL_mplt()

# PTSD2 vs. PTSD1
Tval0 <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="tval", ftxt="lm(formula = y ~ Group + Age + Sex)")
x <- Tval0['GroupPTSD2',]
SDL_mheat(x=x, title='T-value', fmidpoint=0, flimit=c(min(x),max(x)))

Pval0 <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="pval", ftxt="lm(formula = y ~ Group + Age + Sex)")  %>% t() %>% as.data.frame() %>% t()#sapply(p.adjust,method="fdr") %>% t()
x <- -1* log10(Pval0['GroupPTSD2',])
SDL_mheat(x=x, title='-1*log10(P_unc)', fmidpoint=-1*log10(0.05), flimit=c(min(x),max(x)))

# Effect of Age
Tval0 <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="tval", ftxt="lm(formula = y ~ Group + Age + Sex)")
x <- Tval0['Age',]
SDL_mheat(x=x, title='T-value', fmidpoint=0, flimit=c(min(x),max(x)))

Pval0 <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="pval", ftxt="lm(formula = y ~ Group + Age + Sex)")  %>% t() %>% as.data.frame() %>% sapply(p.adjust,method="fdr") %>% t()
x <- -1* log10(Pval0['Age',])
SDL_mheat(x=x, title='-1*log10(P_FDR)', fmidpoint=-1*log10(0.05), flimit=c(min(x),max(x)))

# Effect of Sex
Tval0 <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="tval", ftxt="lm(formula = y ~ Group + Age + Sex)")
x <- Tval0['SexFemale',]
SDL_mheat(x=x, title='T-value', fmidpoint=0, flimit=c(min(x),max(x)))

Pval0 <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="pval", ftxt="lm(formula = y ~ Group + Age + Sex)")  %>% t() %>% as.data.frame() %>% sapply(p.adjust,method="fdr") %>% t()
x <- -1* log10(Pval0['SexFemale',])
SDL_mheat(x=x, title='-1*log10(P_FDR)', fmidpoint=-1*log10(0.05), flimit=c(min(x),max(x)))

# Effect of Group:Age
Tval0 <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="tval", ftxt="lm(formula = y ~ Group * Age + Sex)")
x <- Tval0['GroupPTSD2:Age',]
SDL_mheat(x=x, title='T-value', fmidpoint=0, flimit=c(min(x),max(x)))

Pval0 <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="pval", ftxt="lm(formula = y ~ Group * Age + Sex)")  %>% t() %>% as.data.frame() %>% sapply(p.adjust,method="fdr") %>% t()
x <- -1* log10(Pval0['GroupPTSD2:Age',])
SDL_mheat(x=x, title='-1*log10(P_FDR)', fmidpoint=-1*log10(0.05), flimit=c(min(x),max(x)))

# plot the effects of Group:Age in a sample connection
y <- df[,"V42"]
mod <- lm(formula = y ~ Group * Age + Sex, data=df)
# mod %>% summary()
mod %>% plot_model(type = "pred", terms = c("Age","Group"), title = "dDMN-to-prim_Visual FC",axis.title=c("Age (Years)","rsFC")) # example plot of Group:Age effect

# scatter plots rsFC~Group:Age
df %>% ggplot(aes(x=Age, y=df[,"V42"], color=NewGroup)) + geom_point(size=2) + xlab("Age (Years)") + ylab("rsFC") + labs(title="dDMN-to-prim_Visual FC")


# Effect of Group:Sex
Tval0 <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="tval", ftxt="lm(formula = y ~ Group * Sex + Age)")
x <- Tval0['GroupPTSD2:SexFemale',]
SDL_mheat(x=x, title='T-value', fmidpoint=0, flimit=c(min(x),max(x)))

Pval0 <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="pval", ftxt="lm(formula = y ~ Group * Sex + Age)")  %>% t() %>% as.data.frame() %>% sapply(p.adjust,method="fdr") %>% t()
x <- -1* log10(Pval0['GroupPTSD2:SexFemale',])
SDL_mheat(x=x, title='-1*log10(P_FDR)', fmidpoint=-1*log10(0.05), flimit=c(min(x),max(x)))

# plot the effects of Group:Sex in a sample connection
y <- df[,"V56"]
mod <- lm(formula = y ~ Group * Sex + Age, data=df)
# mod %>% summary()
mod %>% plot_model(type = "pred", terms = c("Group","Sex"), title = "LECN-to-Language FC",axis.title=c("NewGroup","rsFC")) # example plot of Group:Sex effect

# scatter plots rsFC~Group:Sex
df %>% ggboxplot(x="NewGroup", y="V56", color="Sex") + xlab("NewGroup") + ylab("rsFC") + labs(title="LECN-to-Language FC")
```



### Harmonized_symptoms of post-traumatic stress disorder
```{r,echo=FALSE}
# load data
df1 <- read.csv("..\\Output\\FindLab90\\timeseries_PTSD\\PTSD_Datasets_5Sites_Harmonized.csv",header=T,sep=",")
df1 <- df0 %>% merge(df1,by="fID",all=FALSE)

col <- df1 %>% select(Harmonize_PTSD)
ind1 <- df1$NewGroup=='PTSD1'
ind2 <- df1$NewGroup=='PTSD2'
t.test(col[ind1,],col[ind2,])

### function for between-group comparisons (Wilcox test)
# Input
# --- col, dataframe column
# --- df, dataframe
# Output
# --- p-value
SDL_GrpComp <- function(col,df){
  ind1 <- df$NewGroup=='PTSD1'
  ind2 <- df$NewGroup=='PTSD2'
  wilcox.test(col[ind1],col[ind2]) %>% .$p.value
}

# between-group comparison
dfx <- df1 %>% select(Harmonize_PTSD) %>% sapply(SDL_GrpComp,df=df1)

df1 %>% group_by(NewGroup) %>% get_summary_stats(Harmonize_PTSD, type = "mean_sd")
df1 %>% ggplot(aes(x=NewGroup, y=Harmonize_PTSD, fill=NewGroup)) + geom_boxplot() + xlab("NewGroup") + ylab("Harmonized PTSD Symptom Severity")

# Association between FC & clinical measures
## Effects of Harmonize_PTSD (current PTSD symptom severity)
### NewGroup * PTSD1
df <- df1 %>% filter(NewGroup=='PTSD1' | NewGroup=='PTSD2')
Tval <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="tval", ftxt="lm(formula = y ~ NewGroup*Harmonize_PTSD + Age + Sex)")
x <- Tval['NewGroupPTSD2:Harmonize_PTSD',]
SDL_mheat(x=x, title='T-value', fmidpoint=0, flimit=c(-2,2))

Pval <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="pval", ftxt="lm(formula = y ~ NewGroup*Harmonize_PTSD + Age + Sex)")  %>% t() %>% as.data.frame() %>% t()#sapply(p.adjust,method="fdr") %>% t()
x <- -1* log10(Pval['NewGroupPTSD2:Harmonize_PTSD',])
SDL_mheat(x=x, title='-1*log10(P_unc)', fmidpoint=-1*log10(0.05), flimit=c(0,2))

df %>% ggplot(aes(x = Harmonize_PTSD, y = V63, col = as.factor(NewGroup))) + geom_point(size = 1, alpha = .99) + geom_smooth(method = lm, formula = y ~ x, se = T, size = 1.5, linetype = 1, alpha = .4) + theme_minimal() + labs(x="PTSD Symptom Severity",y="rsFC", title = "Visual Spatial -to- Language", subtitle = "") + scale_color_manual(name ="", labels = c("PTSD1", "PTSD2"), values = c("pink", "lightblue"))

### PTSD1
df <- df1 %>% filter(NewGroup=='PTSD1')
Tval <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="tval", ftxt="lm(formula = y ~ Harmonize_PTSD + Age + Sex)")
x <- Tval['Harmonize_PTSD',]
SDL_mheat(x=x, title='T-value', fmidpoint=0, flimit=c(-2,2))

Pval <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="pval", ftxt="lm(formula = y ~ Harmonize_PTSD + Age + Sex)")  %>% t() %>% as.data.frame() %>% t()#sapply(p.adjust,method="fdr") %>% t()
x <- -1* log10(Pval['Harmonize_PTSD',])
SDL_mheat(x=x, title='-1*log10(P_unc)', fmidpoint=-1*log10(0.05), flimit=c(0,2))
cor.test(df$Harmonize_PTSD,df$V63)

# ### PTSD2
# df <- df1 %>% filter(NewGroup=='PTSD2')
# Tval <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="tval", ftxt="lm(formula = y ~ Harmonize_PTSD + Age + Sex)")
# x <- Tval['Harmonize_PTSD',]
# SDL_mheat(x=x, title='T-value', fmidpoint=0, flimit=c(-2,2))
# 
# Pval <- df %>% select(V1:V91) %>% sapply(SDL_lm, df=df, Otype="pval", ftxt="lm(formula = y ~ Harmonize_PTSD + Age + Sex)")  %>% t() %>% as.data.frame() %>% t()#sapply(p.adjust,method="fdr") %>% t()
# x <- -1* log10(Pval['Harmonize_PTSD',])
# SDL_mheat(x=x, title='-1*log10(P_unc)', fmidpoint=-1*log10(0.05), flimit=c(0,2))
# cor.test(df$Harmonize_PTSD,df$V63)

```